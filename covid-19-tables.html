<!doctype html>
<html lang="en">
<head>
    <title>COVID-19 Rates of Change in U.S. Counties</title>
    <meta property="og:type" content="website">
    <meta property="og:title" content="COVID-19 Rates of Change in U.S. Counties">
    <meta property="og:description" content="COVID-19 Rates of Change in U.S. Counties">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.js"></script>

    <style>
      table.dataTable tbody td {
        text-align: right;
      }
      table.dataTable {
        font-family: Arial;
        font-size: 13px;
      }
      #filters {
        margin-bottom: 1em;
      }
    </style>

    <script>
        $(document).ready(function() {

            var table;

            $.ajax("data/counties_rate_of_change.json?", { cache: false }).done(function(data) {
              var date = data[0]['Date'];
              date = date.substring(0,4) + "/" + date.substring(4,6) + "/" + date.substring(6,8);
              $("#heading").html("Data As of " + date);

              var table_data = data.map(row => {
                var fieldnames = Object.keys(row);
                var values = fieldnames
                  .filter(fieldname => fieldname != 'Date')
                  .map(fieldname => row[fieldname]);
                return values;
              });

              var states_set = new Set(data.map(row => row['State']));
              var states = Array.from(states_set.values());
              states.sort();
              states.forEach(state => {
                $("#filter-state").append("<option value='" + state + "'>" + state + "</option>");
              });

              table = $('#counties').DataTable({
                data: table_data,
                lengthMenu: [[20, 50, -1], [20, 50, "All"]]
              });

              table
                .column( '6:visible' )
                .order( 'desc' )
                .draw();
            })
            .fail(function() {
                alert( "error" );
            });

            $("#filter-state").val("");
            $("#filter-county-size").val("");

            $.fn.dataTable.ext.search.push (
                function( settings, data, dataIndex ) {
                    var state = $("#filter-state").val();
                    var county_size = $("#filter-county-size").val();

                    var okay = true;

                    if(state != '' && state != data[1]) {
                      okay = false;
                    }

                    if(county_size == "small") {
                      if(data[4] < 30000) {
                        okay = okay && true;
                      } else {
                        okay = false;
                      }
                    } else if (county_size == "medium") {
                      if(data[4] >= 30000 && data[4] <= 90000) {
                        okay = okay && true;
                      } else {
                        okay = false;
                      }
                    } else if (county_size == "large") {
                      if(data[4] > 90000) {
                        okay = okay && true;
                      } else {
                        okay = false;
                      }
                    }
                    return okay;
                }
            );

            $("#filter-county-size").change(function() {
              table.draw();
            });

            $("#filter-state").change(function() {
              table.draw();
            });

         });

    </script>

</head>
<body>

<h2 id="heading"></h2>

  <p>Sources:
      <ul>
          <li><a href="https://github.com/CSSEGISandData/COVID-19">Novel Coronavirus (COVID-19) Cases, provided by JHU CSSE</a> - county-level data</li>
          <li><a href="https://www.census.gov/data/datasets/time-series/demo/popest/2010s-counties-total.html">Census Bureau: County Population Totals: 2010-2019</a> - county population totals</li>
      </ul>

  <form id="filters">
    <span>Filter by State:</span>

    <select id="filter-state">
      <option value="" selected>All States</option>
    </select>

    <span>Filter by County Size:</span>

    <select id="filter-county-size">
      <option value="" selected>All Counties</option>
      <option value="small">Small (< 30k)</option>
      <option value="medium">Medium (30k - 90k)</option>
      <option value="large">Large (> 90k)</option>
    </select>
  </form>

  <table id="counties" class="display">
    <thead>
      <tr>
        <th>County
        </th>
        <th>State
        </th>
        <th>Confirmed Cases
        </th>
        <th>Deaths
        </th>
        <th>Population
        </th>
        <th>Confirmed Cases<br/>Per 1M Pop.
        </th>
        <th>Deaths<br/>Per 1M Pop.
        </th>
        <th>Change in Last Day,<br/>Confirmed Cases<br/>Per 1M Pop.
        </th>
        <th>Change in Last Day,<br/>Deaths<br/> Per 1M Pop.
        </th>
        <th>Avg Change<br/>over Last 5 Days, <br/>Confirmed Cases<br/>Per 1M Pop.
        </th>
        <th>Avg Change<br/>over Last 5 Days, <br/>Deaths<br/>Per 1M Pop.
        </th>
      </tr>
    </thead>
    <tbody id="table-body">
    </tbody>
  </table>

</body>
</html>
