<!doctype html>
<html lang="en">
<head>
    <title>COVID-19 U.S. Stats Per Capita</title>
    <meta property="og:type" content="website">
    <meta property="og:title" content="COVID-19 U.S. Stats Per Capita">
    <meta property="og:description" content="Charts showing U.S. County and State trends for confirmed cases and deaths per capita">
    <style>
    canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
    .canvas-container {
        width: 85%;
        margin-top: 2em;
        margin-bottom: 2em
    }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>

        //https://medialab.github.io/iwanthue/
        var colors =[
            "#000000",
            "#55bb6a",
            "#a04bc5",
            "#52c854",
            "#b82c90",
            "#7cb537",
            "#626cde",
            "#b6bf36",
            "#7b55b3",
            "#3c8f2b",
            "#e663c1",
            "#5ece9d",
            "#e0458b",
            "#347a3c",
            "#d07ce5",
            "#6d8d31",
            "#a24e99",
            "#dea833",
            "#658ad8",
            "#e2772d",
            "#5da3d6",
            "#bc411e",
            "#48c6ca",
            "#e74e49",
            "#41a68c",
            "#db3c64",
            "#5da066",
            "#ac3e67",
            "#9bbd6f",
            "#5f5ea0",
            "#91932e",
            "#c291d6",
            "#506b15",
            "#df82ab",
            "#367042",
            "#b64342",
            "#308266",
            "#e28084",
            "#1a6447",
            "#e78d69",
            "#4d662b",
            "#925178",
            "#c4b468",
            "#a25356",
            "#849357",
            "#a0592f",
            "#666828",
            "#dc9e57",
            "#806229",
            "#a6791b",
            "#b38e57"
        ];

        var states;

        function comparator(a,b) {
            return a.x < b.x ? -1 : (a.x > b.x ? 1 : 0);
        }

        // YYYYMMDD -> date obj. arg can be a string or int
        function datevalue_to_date(date_value) {
            var datestr = String(date_value);
            return new Date(
                parseInt(datestr.substring(0, 4)),
                parseInt(datestr.substring(4, 6)) -1,
                parseInt(datestr.substring(6, 8))
            )
        }

        // get the labels (unique X values) from a dataset
        function get_labels(dataset) {
            return dataset.map((point) => point.x);
        }

        // datasets is an array of arrays. handles dates properly.
        function union_labels(datasets) {
            var s = new Set();
            var is_dates = false;
            datasets.forEach(function(dataset) {
                get_labels(dataset).forEach(function(label) {
                    var v = label;
                    if(label instanceof Date) {
                        is_dates = true;
                        v = label.getTime();
                    }
                    s.add(v);
                });
            });
            var sorted = Array.from(s).sort();
            if(is_dates) {
                sorted = sorted.map(v => new Date(v));
            }
            return sorted;
        }

        // set difference A - B
        function difference(setA, setB) {
            let _difference = new Set(setA)
            for (let elem of setB) {
                _difference.delete(elem)
            }
            return _difference
        }

        // fill in dataset with points with 0 value if it doesn't have entries in labels
        // chartjs doesn't display tooltips correctly unless we do this
        function zero_fill(dataset, labels) {
            var existing = get_labels(dataset);

            var is_date = labels.some(v => v instanceof Date);

            var a = labels.map(v => is_date ? v.getTime() : v);
            var b = existing.map(v => is_date ? v.getTime() : v);

            var missing = difference(new Set(a), new Set(b))
            missing.forEach(function(v) {
                if(is_date) {
                    v = new Date(v)
                }
                dataset.push({ x: v, y: 0 })
            });
            dataset.sort(comparator);
        }

        function get_states_sorted_by_last_value(data_for_states) {
            return Object.keys(data_for_states)
                .map(state => {
                    var points = data_for_states[state];
                    var last_value = points[points.length - 1];
                    return {
                        state: state,
                        last_value: last_value.y
                    };
                })
                .sort((a,b) => a.last_value < b.last_value ? -1 : (a.last_value > b.last_value ? 1 : 0))
                .reverse()
                .map(record => record.state);
        }

        // data for a chart
        function get_states_chart_data(data, field, align_start = false) {

            var data_for_states_all = data
                .reduce((acc, record) => {
                    var state = record.state;
                    if(state in states) {
                        var pop = parseFloat(states[state].Population);
                        if(record[field] > 0 && !!record.date) {
                            if (!acc[state]) {
                                acc[state] = [];
                            }
                            var y = record[field] / (pop / 1000000);
                            y = Math.round(y * 10000) / 10000;
                            acc[state].push({
                                x: datevalue_to_date(record.date),
                                y: y,
                                count: record[field],
                                population: pop
                            });
                        }
                    }
                    return acc;
                }, {});

            var data_for_states = {};

            // filter out states that have all 0 y values
            Object.keys(data_for_states_all).forEach(state => {
                var keep = data_for_states_all[state].some(point => point.y > 0);
                if(keep) {
                    data_for_states[state] = data_for_states_all[state];
                }
            });

            Object.values(data_for_states).forEach(v => v.sort(comparator));

            if(align_start) {
                Object.keys(data_for_states).forEach((state) => {
                    var dataset = data_for_states[state];
                    data_for_states[state] = dataset
                    .filter(point => point.y > 0)
                    .reduce((acc, point, idx) => {
                        if(point.y > 0) {
                            if(acc.length == 0) {
                                acc.push({ x: "Day 000", y: 0, count: 0, population: point.population });
                            }
                            var new_point = copy_object(point);
                            new_point.date = point.x;
                            new_point.x = "Day " + String(acc.length).padStart(3, "0");
                            acc.push(new_point);
                        }
                        return acc;
                    }, [])
                })
            }

            var labels = union_labels(Object.values(data_for_states));

            if(!align_start) {
                Object.values(data_for_states).forEach(dataset => zero_fill(dataset, labels));
            }
 
            // sort to make it easier to navigate "down" the chart legend to
            // toggle the highest counts on/off
            var states_sorted = get_states_sorted_by_last_value(data_for_states);

            var chart_data = states_sorted.map(function(state, idx) {
                var color = states[state].color;
                return {
                    label: state,
                    backgroundColor: color,
                    borderColor: color,
                    data: data_for_states[state],
                    fill: false,
                    lineTension: 0
                }
            });

            return {
                labels: labels,
                chart_data: chart_data
            };
        }

        function tooltip_count_pop(tooltipItem, data) {
            var label = data.datasets[tooltipItem.datasetIndex].label || '';
            var datum = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
            if (label) {
                label += ': ';
            }
            label += tooltipItem.yLabel;
            label += " - Count: " + Number(datum.count).toLocaleString() + " / Pop: " + Number(datum.population).toLocaleString();
            if(datum.date) {
                label += " on " + datum.date.toDateString();
            }
            return label;
        }

        function tooltip_title(items, data) {
            var title = items[0].xLabel;
            return title.substring(0, 12);
        }

        function copy_object(obj) {
            return JSON.parse(JSON.stringify(obj));
        }

        // filter from CSSE by county and transform to objects fit for chartjs
        function get_counties_chart_data(data, field_measure, population_filter) {
            var field_count;
            var field_rank;
            if(field_measure == 'ConfirmedPer1M') {
                field_count = 'Confirmed';
                field_rank = 'ConfirmedRank';
            } else if(field_measure == 'DeathsPer1M') {
                field_count = 'Deaths';
                field_rank = 'DeathRank';
            }

            var filtered = data
                .filter(record => population_filter(record.Population))
                .map(record => {
                    record.county = record.Admin2 + ', ' + record.StateAbbrev;
                    return record;
                });

            // order counties to make it easier to navigate "down" the chart legend to
            // toggle the highest counts on/off
            var counties_sorted = Object.values(
                filtered
                .reduce((acc, record) => {
                    acc[record.county] = {
                        county: record.county,
                        rank: record[field_rank]
                    };
                    return acc;
                }, {})
                )
                .sort((a,b) => a.rank < b.rank ? -1 : (a.rank > b.rank ? 1 : 0))
                .map(record => record.county)
                // take top 30
                .slice(0, 30);

            var data_for_counties = filtered
                .map(function(record) {
                    var y = Math.round(record[field_measure] * 10000) / 10000;
                    return {
                        county: record.county,
                        x: datevalue_to_date(record.Date),
                        y: y,
                        count: record[field_count],
                        population: record.Population
                    }
                })
                .reduce((acc, point) => {
                    if(!acc[point.county]) {
                        acc[point.county] = [];
                    }
                    var county = point.county;
                    delete point.county;
                    acc[county].push(point);
                    return acc;
                }, {});

            Object.values(data_for_counties).forEach(v => v.sort(comparator));

            var labels = union_labels(Object.values(data_for_counties));

            var chart_data = counties_sorted.map(function(county, idx) {
                var color = colors[idx];
                return {
                    label: county,
                    backgroundColor: color,
                    borderColor: color,
                    data: data_for_counties[county],
                    fill: false,
                    lineTension: 0
                }
            });

            return {
                labels: labels,
                chart_data: chart_data
            };
        }

        $(document).ready(function() {

            var config_template = {
                type: 'line',
                data: {
                },
                options: {
                    responsive: true,
                    title: {
                        display: true,
                        fontSize: 20
                    },
                    tooltips: {
                        mode: 'point',
                        intersect: false,
                        titleFontSize: 16,
                        bodyFontSize: 14,
                        callbacks: {
                        }
                    },
                    hover: {
                        mode: 'nearest',
                        intersect: false
                    },
                    scales: {
                        yAxes: [{
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Counts Per 1M Pop.'
                            }
                        }]
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            };

            function clone_config_template() {
                var config = copy_object(config_template);
                // function reference this can't be copied
                config.options.tooltips.callbacks.label = tooltip_count_pop;
                config.options.tooltips.callbacks.title = tooltip_title;
                return config;
            }

            function config_xaxis_date(config) {
                config.options.scales.xAxes =  [{
                    display: true,
                    type: 'time',
                    time: {
                        unit: 'day'
                    },
                    scaleLabel: {
                        display: true,
                        labelString: 'Date'
                    }
                }];
            }

            function config_xaxis_daycount(config) {
                config.options.scales.xAxes =  [{
                    display: true,
                    type: 'category',
                    scaleLabel: {
                        display: true,
                        labelString: 'Day'
                    }
                }];
            }

            var covidtracking_data;

            $.when(

                $.get("https://covidtracking.com/api/states/daily", function(data) {
                    covidtracking_data = data;
                }),

                $.get("data/state_population.json", function(data) {
                    states = data
                        .map((state, idx) => { state.color = colors[idx]; return state; })
                        .reduce((acc, state) => {
                            acc[state.StateAbbrev] = state;
                            return acc;
                        }, {})
                })

            ).then(function() {

                var data = covidtracking_data;

                // confirmed chart

                var chart_data_confirmed = get_states_chart_data(data, 'positive');

                var config_confirmed = clone_config_template();
                config_xaxis_date(config_confirmed);

                config_confirmed.options.title.text = 'By State: Confirmed Tests';
                config_confirmed.data.labels = chart_data_confirmed.labels;
                config_confirmed.data.datasets = chart_data_confirmed.chart_data;

                var ctx_confirmed = document.getElementById('canvas-confirmed').getContext('2d');
                new Chart(ctx_confirmed, config_confirmed);

                // deaths chart

                var chart_data_deaths = get_states_chart_data(data, 'death');

                var config_deaths = clone_config_template();
                config_xaxis_date(config_deaths);

                config_deaths.options.title.text = 'By State: Total Cumulative Deaths';
                config_deaths.data.labels = chart_data_deaths.labels;
                config_deaths.data.datasets = chart_data_deaths.chart_data;

                var ctx_deaths = document.getElementById('canvas-deaths').getContext('2d');
                new Chart(ctx_deaths, config_deaths);

                // confirmed chart, aligned

                var chart_data_confirmed_aligned = get_states_chart_data(data, 'positive', true);

                var config_confirmed_aligned = clone_config_template();
                config_xaxis_daycount(config_confirmed_aligned);

                config_confirmed_aligned.options.title.text = 'By State: Confirmed Tests, Aligned to First Confirmed Test';
                config_confirmed_aligned.data.labels = chart_data_confirmed_aligned.labels;
                config_confirmed_aligned.data.datasets = chart_data_confirmed_aligned.chart_data;

                var ctx_confirmed_aligned = document.getElementById('canvas-confirmed-aligned').getContext('2d');
                new Chart(ctx_confirmed_aligned, config_confirmed_aligned);

                // deaths chart

                var chart_data_deaths_aligned = get_states_chart_data(data, 'death', true);

                var config_deaths_aligned = clone_config_template();
                config_xaxis_daycount(config_deaths_aligned);

                config_deaths_aligned.options.title.text = 'By State: Total Cumulative Deaths, Aligned to First Death';
                config_deaths_aligned.data.labels = chart_data_deaths_aligned.labels;
                config_deaths_aligned.data.datasets = chart_data_deaths_aligned.chart_data;

                var ctx_deaths_aligned = document.getElementById('canvas-deaths-aligned').getContext('2d');
                new Chart(ctx_deaths_aligned, config_deaths_aligned);

            });

            $.ajax("data/counties_ranked.json?", { cache: false }).done(function(data) {

                function draw_chart_county(title, field_measure, population_filter, element_id) {
                    var chart_data = get_counties_chart_data(data, field_measure, population_filter);

                    var config = clone_config_template();
                    config_xaxis_date(config);

                    config.options.title.text = title;
                    config.data.labels = chart_data.labels;
                    config.data.datasets = chart_data.chart_data;

                    var ctx = document.getElementById(element_id).getContext('2d');
                    new Chart(ctx, config);
                }

                /*

                // thresholds for county size determined by evenly distributing counties into 3 sizes (i.e. using ntiles)

                with pop as (
                    select distinct
                        FIPS, Population
                    FROM counties_ranked
                )
                ,WithNTiles as (
                    select
                        *
                        ,ntile(3) over (order by population) as GroupSize
                    from pop
                )
                select
                    GroupSize,
                    min(population),
                    max(population),
                    count(*)
                from WithNTiles
                group by GroupSize
                */

                // small

                draw_chart_county(
                    'By Small County (pop < 30k): Confirmed Tests, Top 30',
                    'ConfirmedPer1M',
                    pop => pop < 30000,
                    'canvas-county-sm-confirmed'
                );

                draw_chart_county(
                    'By Small County (pop < 30k): Total Cumulative Deaths, Top 30',
                    'DeathsPer1M',
                    pop => pop < 30000,
                    'canvas-county-sm-deaths'
                );

                // medium

                draw_chart_county(
                    'By Med-Sized County (pop 30k-90k): Confirmed Tests, Top 30',
                    'ConfirmedPer1M',
                    pop => pop >= 30000 && pop <= 90000,
                    'canvas-county-md-confirmed'
                );

                draw_chart_county(
                    'By Med-Sized County (pop 30k-90k): Total Cumulative Deaths, Top 30',
                    'DeathsPer1M',
                    pop => pop >= 30000 && pop <= 90000,
                    'canvas-county-md-deaths'
                );

                // large

                draw_chart_county(
                    'By Large County (pop >= 90k): Confirmed Tests, Top 30',
                    'ConfirmedPer1M',
                    pop => pop >= 90000,
                    'canvas-county-lg-confirmed'
                );

                draw_chart_county(
                    'By Large County (pop >= 90k): Total Cumulative Deaths, Top 30',
                    'DeathsPer1M',
                    pop => pop >= 90000,
                    'canvas-county-lg-deaths'
                );


            })
            .fail(function() {
                alert( "error" );
            });

         });

    </script>

</head>

<body>
    <h2>Charts on this page</h2>
        <p>All counts are adjusted for population size (per 1M).

    <p>Charts by state:
        <ul>
            <li><a href="#canvas-confirmed">By State: Confirmed Tests</a></li>
            <li><a href="#canvas-deaths">By State: Total Cumulative Deaths</a></li>
            <li><a href="#canvas-confirmed-aligned">By State: Confirmed Tests, Aligned to First Confirmed Test</a></li>
            <li><a href="#canvas-deaths-aligned">By State: Total Cumulative Deaths, Aligned to First Death</a></li>
        </ul>

    <p>Charts by county:
        <ul>
            <li><a href="#canvas-county-sm-confirmed">By Small County (pop < 30k): Confirmed Tests, Top 30</a></li>
            <li><a href="#canvas-county-sm-deaths">By Small County (pop < 30k): Total Cumulative Deaths, Top 30</a></li>
            <li><a href="#canvas-county-md-confirmed">By Med-Sized County (pop 30k-90k): Confirmed Tests, Top 30</a></li>
            <li><a href="#canvas-county-md-deaths">By Med-Sized County (pop 30k-90k): Total Cumulative Deaths, Top 30</a></li>
            <li><a href="#canvas-county-lg-confirmed">By Large County (pop >= 90k): Confirmed Tests, Top 30</a></li>
            <li><a href="#canvas-county-lg-deaths">By Large County (pop >= 90k): Total Cumulative Deaths, Top 30</a></li>
        </ul>

    <p>Notes:
        <ul>
            <li>Click labels in the legend to toggle a line off and on; this will rescale the vertical axis as well.</li>
            <li>The legend is sorted to make it easier to go down the list and toggle off the top lines, so you can better see others.</li>
        </ul>

    <p>Sources:
        <ul>
            <li><a href="https://covidtracking.com/">The COVID Tracking Project</a> - state-level data</li> 
            <li><a href="https://www.census.gov/data/datasets/time-series/demo/popest/2010s-state-total.html">Census Bureau: State Population Totals: 2010-2019</a> - state population totals</li>
            <li><a href="https://github.com/CSSEGISandData/COVID-19">Novel Coronavirus (COVID-19) Cases, provided by JHU CSSE</a> - county-level data</li>
            <li><a href="https://www.census.gov/data/datasets/time-series/demo/popest/2010s-counties-total.html">Census Bureau: County Population Totals: 2010-2019</a> - county population totals</li>
        </ul>

    <div class="canvas-container">
        <canvas id="canvas-confirmed"></canvas>
    </div>
    <div class="canvas-container">
        <canvas id="canvas-deaths"></canvas>
    </div>
    <div class="canvas-container">
        <canvas id="canvas-confirmed-aligned"></canvas>
    </div>
    <div class="canvas-container">
        <canvas id="canvas-deaths-aligned"></canvas>
    </div>
    <div class="canvas-container">
        <canvas id="canvas-county-sm-confirmed"></canvas>
    </div>
    <div class="canvas-container">
        <canvas id="canvas-county-sm-deaths"></canvas>
    </div>
    <div class="canvas-container">
        <canvas id="canvas-county-md-confirmed"></canvas>
    </div>
    <div class="canvas-container">
        <canvas id="canvas-county-md-deaths"></canvas>
    </div>
    <div class="canvas-container">
        <canvas id="canvas-county-lg-confirmed"></canvas>
    </div>
    <div class="canvas-container">
        <canvas id="canvas-county-lg-deaths"></canvas>
    </div>

</body>

</html>
