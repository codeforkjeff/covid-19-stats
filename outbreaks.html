<!DOCTYPE html>
<html>
<head>
	
	<title>COVID-19 Outbreaks</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

	<style>
		#controls {
			margin-bottom: 10px;
		}
		#map-container {
			position: relative;
		}
		#map {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 100%;
		}
	</style>
</head>
<body>

	<h2 id="heading"></h2>

  <form id="controls">
    
    Show 100 Counties with Highest <select id="view-by">
      <option value="day">New Cases in Last Day</option>
      <option value="day_pct">% Change in New Cases in Last Day</option>
      <option value="week">New Cases in Last Week</option>
      <option value="week_pct">% Change in New Cases in Last Week</option>
      <option value="twoweek" selected>New Cases in Last 2 Weeks</option>
      <option value="twoweek_pct">% Change in New Cases in Last 2 Weeks</option>
      <option value="month">New Cases in Last Month</option>
      <option value="month_pct">% Change in New Cases in Last Month</option>
    </select>

    <span style="margin-left: 2em;">
    Bubble Scale
    <select id="bubble-size">
    	<option value="small">Small: 1 Case = 2m, 1 Pct Point = 50m</option>
    	<option value="medium" selected>Medium: 1 Case = 5m, 1 Pct Point = 100m</option>
    	<option value="large">Large: 1 Case = 10m, 1 Pct Point = 300m</option>
	</select>
	</span>
  </form>

	<div id="map-container">
		<div id="map"></div>
	</div>
	<script>

$(document).ready(function() {
	var MULT_NUM_CASES;
	var MULT_PCT;

	function create_comparator(attr) {
        return function(a,b) {
        	var x = a[attr] || 0;
        	var y = b[attr] || 0;
	        return x < y ? -1 : (x > y ? 1 : 0);
        };
	}

    document.getElementById("map-container").style.height = (window.innerHeight - 120) + "px";

	var mymap = L.map('map').setView([37.0902, -95.7129], 5);

	L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYWJzb2x1dGVseWplZmYiLCJhIjoiY2tjZWR4MHF1MDExczJzbnE5NW9ndjJwNiJ9.qhl-MLfZfDvdm7tdI01NAA', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox/light-v10',
		tileSize: 512,
		zoomOffset: -1
	}).addTo(mymap);

	var circles = [];
	var county_data;

	function set_bubble_size() {

		var size = $("#bubble-size").val()

		if(size == 'small') {
			MULT_NUM_CASES = 2;
			MULT_PCT = 50 * 100;
		} else if(size == 'medium') {
			MULT_NUM_CASES = 5;
			MULT_PCT = 100 * 100;
		} else if(size == 'large') {
			MULT_NUM_CASES = 10;
			MULT_PCT = 300 * 100;
		}
	}


	function draw_circles() {
		var field;

		// radius value is in meters
		var radius_multipler;

		if($("#view-by").val() == 'day') {
			field = 'ConfirmedIncrease';
			radius_multipler = MULT_NUM_CASES;
		} else if($("#view-by").val() == 'day_pct') {
			field = 'ConfirmedIncreasePct';
			radius_multipler = MULT_PCT;
		} else if($("#view-by").val() == 'week') {
			field = 'OneWeekConfirmedIncrease';
			radius_multipler = MULT_NUM_CASES;
		} else if($("#view-by").val() == 'week_pct') {
			field = 'OneWeekConfirmedIncreasePct';
			radius_multipler = MULT_PCT;
		} else if($("#view-by").val() == 'twoweek') {
			field = 'TwoWeekConfirmedIncrease';
			radius_multipler = MULT_NUM_CASES;
		} else if($("#view-by").val() == 'twoweek_pct') {
			field = 'TwoWeekConfirmedIncreasePct';
			radius_multipler = MULT_PCT;
		} else if($("#view-by").val() == 'month') {
			field = 'MonthConfirmedIncrease';
			radius_multipler = MULT_NUM_CASES;
		} else if($("#view-by").val() == 'month_pct') {
			field = 'MonthConfirmedIncreasePct';
			radius_multipler = MULT_PCT;
		}
    	
    	county_data.sort(create_comparator(field));
    	county_data.reverse();

    	circles.forEach(circle => circle.remove());
    	circles = [];

    	for(var i = 0; i < 100; i++) {
    		var record = county_data[i];
			var radius = record[field] * radius_multipler;

			var circle = L.circle([record.Lat, record.Long_], {
				color: 'red',
				fillColor: '#f03',
				fillOpacity: 0.5,
				radius: radius
			});

			circle.bindPopup(
				'<b>County: ' + record.County + ', ' + record.State + '</b>' +
				'<br/>' + 'Population: ' + record.Population +
				'<br/>' + 'Total Cases to Date: ' + record.Confirmed + 
				'<br/>' + 'New Cases in Last Day: ' + record.ConfirmedIncrease + ' (+' + (record.ConfirmedIncreasePct * 100).toFixed(2) + '%)' +
				'<br/>' + 'New Cases in Last Week: ' + record.OneWeekConfirmedIncrease.toFixed(2) + ' (+' + (record.OneWeekConfirmedIncreasePct * 100).toFixed(2) + '%)' +
				'<br/>' + 'New Cases in Last 2 Weeks: ' + record.TwoWeekConfirmedIncrease.toFixed(2) + ' (+' + (record.TwoWeekConfirmedIncreasePct * 100).toFixed(2) + '%)' +
				'<br/>' + 'New Cases in Last Month: ' + record.MonthConfirmedIncrease.toFixed(2) +
					' (+' + (record.MonthConfirmedIncreasePct * 100).toFixed(2) + '%)'
			)
			.addTo(mymap);

			circles.push(circle);
		}

	}

    $.ajax("data/counties_rate_of_change.json").done(function(data) {

		var date = data[0]['Date'];
		$("#heading").html("COVID-19 Outbreaks - As of " + date);

    	county_data = data;

    	set_bubble_size();

    	draw_circles();
    });

    $("#view-by").change(function() {
      	draw_circles();
    });

    $("#bubble-size").change(function() {
    	set_bubble_size();
      	draw_circles();
    });
});

	</script>

</body>
</html>
