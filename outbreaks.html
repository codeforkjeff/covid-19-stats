<!DOCTYPE html>
<html>
<head>
	
	<title>COVID-19 Outbreaks</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

	<style>
		#controls {
			margin-bottom: 10px;
		}
		#map-container {
			position: relative;
		}
		#map {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 100%;
		}
		.county-table {
			border-collapse: collapse;
		}
		.county-table td {
			padding: 1px;
		}
		.county-table tr:nth-child(1) {
			font-weight: bold;
		}
		.county-table td:nth-child(1) {
			white-space: nowrap;
		}
		.county-table td:nth-child(2) {
			text-align: right;
		}
		.county-table td:nth-child(3) {
			padding-left: 1em;
			text-align: right;
		}

	</style>
</head>
<body>

	<h2 id="heading"></h2>

  <form id="controls">
    
    Show 100 Counties with Highest <select id="view-by">
      <option value="twoweek_7dayavg" selected>Increase in 7 day avg over Last 2 Weeks</option>
      <option value="twoweek_7dayavg_pct">Increase in 7 day avg over Last 2 Weeks - % Change</option>
      <option value="month_7dayavg">Increase in 7 day avg over Last Month</option>
      <option value="month_7dayavg_pct">Increase in 7 day avg over Last Month - % Change</option>
      <option value="day">New Cases in Last Day</option>
      <option value="day_pct">New Cases in Last Day - % Change</option>
      <option value="week">New Cases in Last Week</option>
      <option value="week_pct">New Cases in Last Week - % Change</option>
      <option value="twoweek">New Cases in Last 2 Weeks</option>
      <option value="twoweek_pct">New Cases in Last 2 Weeks - % Change</option>
      <option value="month">New Cases in Last Month</option>
      <option value="month_pct">New Cases in Last Month - % Change</option>
    </select>

    <span style="margin-left: 2em;">
    Bubble Size (sq. miles per case or per % pt)
    <select id="bubble-size">
    	<option value="0.05">0.05</option>
    	<option value="0.1" selected>0.1</option>
    	<option value="1.0">1.0 </option>
    	<option value="3.0" selected>3.0</option>
	</select>
	</span>
  </form>

	<div id="map-container">
		<div id="map"></div>
	</div>
	<script>

$(document).ready(function() {
	const KM_PER_MI = 2589988;

	var mult_num_cases;
	var mult_pct;

	function create_comparator(attr) {
        return function(a,b) {
        	var x = a[attr] || 0;
        	var y = b[attr] || 0;
	        return x < y ? -1 : (x > y ? 1 : 0);
        };
	}

    document.getElementById("map-container").style.height = (window.innerHeight - 120) + "px";

	var mymap = L.map('map').setView([37.0902, -95.7129], 5);

	L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYWJzb2x1dGVseWplZmYiLCJhIjoiY2tjZWR4MHF1MDExczJzbnE5NW9ndjJwNiJ9.qhl-MLfZfDvdm7tdI01NAA', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox/light-v10',
		tileSize: 512,
		zoomOffset: -1
	}).addTo(mymap);

	var circles = [];
	var county_data;

	function set_bubble_size() {

		var size = $("#bubble-size").val()

		// multipliers are in square meters

		mult_num_cases = parseFloat(size) * KM_PER_MI;
		mult_pct = mult_num_cases * 100;
	}


	function draw_circles() {
		var field;

		var view_by = $("#view-by").val();

		// radius value is in meters
		var radius_multipler;

		if(view_by == 'twoweek_7dayavg') {
			field = 'TwoWeekAvg7DayConfirmedIncrease';
			radius_multipler = mult_num_cases;
		} else if(view_by == 'twoweek_7dayavg_pct') {
			field = 'TwoWeekAvg7DayConfirmedIncreasePct';
			radius_multipler = mult_pct;
		} else if(view_by == 'month_7dayavg') {
			field = 'MonthAvg7DayConfirmedIncrease';
			radius_multipler = mult_num_cases;
		} else if(view_by == 'month_7dayavg_pct') {
			field = 'MonthAvg7DayConfirmedIncreasePct';
			radius_multipler = mult_pct;
		} else if(view_by == 'day') {
			field = 'ConfirmedIncrease';
			radius_multipler = mult_num_cases;
		} else if(view_by == 'day_pct') {
			field = 'ConfirmedIncreasePct';
			radius_multipler = mult_pct;
		} else if(view_by == 'week') {
			field = 'OneWeekConfirmedIncrease';
			radius_multipler = mult_num_cases;
		} else if(view_by == 'week_pct') {
			field = 'OneWeekConfirmedIncreasePct';
			radius_multipler = mult_pct;
		} else if(view_by == 'twoweek') {
			field = 'TwoWeekConfirmedIncrease';
			radius_multipler = mult_num_cases;
		} else if(view_by == 'twoweek_pct') {
			field = 'TwoWeekConfirmedIncreasePct';
			radius_multipler = mult_pct;
		} else if(view_by == 'month') {
			field = 'MonthConfirmedIncrease';
			radius_multipler = mult_num_cases;
		} else if(view_by == 'month_pct') {
			field = 'MonthConfirmedIncreasePct';
			radius_multipler = mult_pct;
		}

    	county_data.sort(create_comparator(field));
    	county_data.reverse();

    	circles.forEach(circle => circle.remove());
    	circles = [];

    	for(var i = 0; i < 100; i++) {
    		var record = county_data[i];

    		var area = record[field] * radius_multipler;
			var radius = parseInt(Math.sqrt(area  / 3.14));

			var circle = L.circle([record.Lat, record.Long_], {
				color: 'red',
				fillColor: '#f03',
				fillOpacity: 0.5,
				radius: radius
			});

			circle.bindPopup(
				`
				<table class="county-table">
				<tr>
					<td>County: ${record.County}, ${record.State}</td>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td>Population:</td>
					<td>${record.Population}</td>
					<td></td>
				</tr>
				<tr>
					<td>Total Cases to Date:</td>
					<td>${record.Confirmed}</td>
					<td></td>
				</tr>
				<tr>
					<td>New Cases in Last Day:</td>
					<td>${record.ConfirmedIncrease}</td>
					<td>+${(record.ConfirmedIncreasePct * 100).toFixed(2)}%</td>
				</tr>
				<tr>
					<td>New Cases in Last Week:</td>
					<td>${record.OneWeekConfirmedIncrease}</td>
					<td>+${(record.OneWeekConfirmedIncreasePct * 100).toFixed(2)}%</td>
				</tr>
				<tr>
					<td>New Cases in Last 2 Weeks:</td>
					<td>${record.TwoWeekConfirmedIncrease}</td>
					<td>+${(record.TwoWeekConfirmedIncreasePct * 100).toFixed(2)}%</td>
				</tr>
				<tr>
					<td>New Cases in Last Month:</td>
					<td>${record.MonthConfirmedIncrease}</td>
					<td>+${(record.MonthConfirmedIncreasePct * 100).toFixed(2)}%</td>
				</tr>
				<tr>
					<td>Change in 7 Day Avg over Last 2 Weeks:</td>
					<td>+${record.TwoWeekAvg7DayConfirmedIncrease.toFixed(0)}</td>
					<td>+${(record.TwoWeekAvg7DayConfirmedIncreasePct * 100).toFixed(2)}%</td>
				</tr>
				<tr>
					<td>Change in 7 Day Avg over Last Month:</td>
					<td>+${record.MonthAvg7DayConfirmedIncrease.toFixed(0)}</td>
					<td>+${(record.MonthAvg7DayConfirmedIncreasePct * 100).toFixed(2)}%</td>
				</tr>
				</table>
				`, {
				  maxWidth: "auto"
				}
			)
			.addTo(mymap);

			circles.push(circle);
		}

	}

    $.ajax("data/counties_rate_of_change.json").done(function(data) {

		var date = data[0]['Date'];
		$("#heading").html("COVID-19 Outbreaks - As of " + date);

    	county_data = data;

    	set_bubble_size();

    	draw_circles();
    });

    $("#view-by").change(function() {
      	draw_circles();
    });

    $("#bubble-size").change(function() {
    	set_bubble_size();
      	draw_circles();
    });
});

	</script>

</body>
</html>
